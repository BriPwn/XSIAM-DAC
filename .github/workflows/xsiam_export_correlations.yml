name: Export XSIAM Objects to exports/

on:
  workflow_dispatch:
    inputs:
      only_enabled:
        description: "Export only enabled correlations (and enabled BIOCs when supported)"
        required: false
        default: "false"
      name_prefix:
        description: "Optional name prefix filter (correlations/BIOCs only), e.g. DAC:"
        required: false
        default: ""
      limit:
        description: "Optional max objects per type (0 = no limit)"
        required: false
        default: "0"
      export_biocs:
        description: "Attempt BIOC export (will auto-skip if BIOC not supported)"
        required: false
        default: "true"

permissions:
  contents: write

concurrency:
  group: xsiam-export
  cancel-in-progress: false

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Export from XSIAM into exports/
        env:
          # XSIAM auth
          XSIAM_FQDN: ${{ secrets.XSIAM_FQDN }}
          XSIAM_API_KEY: ${{ secrets.XSIAM_API_KEY }}
          XSIAM_API_KEY_ID: ${{ secrets.XSIAM_API_KEY_ID }}

          # Export controls
          EXPORT_ROOT: exports
          EXPORT_CORRELATIONS: "true"
          EXPORT_IOCS: "true"
          EXPORT_BIOCS: ${{ github.event.inputs.export_biocs }}

          EXPORT_ONLY_ENABLED: ${{ github.event.inputs.only_enabled }}
          EXPORT_NAME_PREFIX: ${{ github.event.inputs.name_prefix }}
          EXPORT_LIMIT: ${{ github.event.inputs.limit }}

          # If your tenant says "BIOC not supported", exporter will skip BIOCs when STRICT_BIOC is false
          STRICT_BIOC: "false"

          DRY_RUN: "false"
        run: |
          python -u scripts/export_xsiam_objects.py
          echo "=== EXPORTS TREE ==="
          ls -la exports || true
          find exports -maxdepth 2 -type f -name "*.json" -print | head -n 50 || true

      - name: Commit exports/ changes
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Ensure exports exists in repo (even if empty) for first run
          mkdir -p exports

          # Only add exports folder
          git add -A exports

          if git diff --cached --quiet; then
            echo "No changes in exports/ to commit."
            exit 0
          fi

          git commit -m "chore: export XSIAM objects to exports/"
          git push
